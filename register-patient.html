<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Registration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
    
    <style>
        #mapContainer {
            height: 350px;
            border-radius: 5px;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">Patient Registration</h4>
                    <small>Register as a Patient</small>
                </div>

                <div class="card-body p-4">

                    <!-- STEP INDICATOR -->
                    <ul class="nav nav-pills mb-4 justify-content-center" id="stepTabs">
                        <li class="nav-item">
                            <button class="nav-link active" type="button">Step 1</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link disabled" type="button">Step 2</button>
                        </li>
                    </ul>

                    <form id="patientForm" enctype="multipart/form-data">

                        <!-- STEP 1: Personal Info -->
                        <div id="step1">
                            <h6 class="text-primary mb-3">Personal Information</h6>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" name="first_name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" name="last_name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Birthdate</label>
                                    <input type="date" name="birthdate" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Gender</label>
                                    <select name="gender" class="form-select" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" name="email" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Contact Number</label>
                                    <input type="text" name="contact_no" class="form-control" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Location on Map</label>
                                    <div id="mapContainer"></div>
                                    <small class="text-muted">Drag the pin to set your location</small>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Address</label>
                                    <textarea name="address" class="form-control" rows="2" placeholder="Drag pin on map to auto-fill" required></textarea>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                            </div>
                        </div>

                        <!-- STEP 2: Account & ID -->
                        <div id="step2" class="d-none">
                            <h6 class="text-primary mb-3">Account & ID Verification</h6>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" name="username" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Password</label>
                                    <input type="password" name="password" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" name="confirm_password" class="form-control" required>
                                </div>
                            </div>

                            <h6 class="text-primary mb-3">Valid ID Verification</h6>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">ID Type</label>
                                    <select id="idType" name="id_type" class="form-select" required>
                                        <option value="">Select ID</option>
                                        <option value="passport">Passport</option>
                                        <option value="drivers">Driver's License</option>
                                        <option value="national">National ID</option>
                                        <option value="philhealth">PhilHealth ID</option>
                                        <option value="sss">SSS ID</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">ID Number</label>
                                    <input type="text" id="idNumber" name="id_number" class="form-control" required>
                                    <small class="text-danger d-none" id="idError">Invalid ID number format</small>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Upload Valid ID</label>
                                    <input type="file" id="idFile" name="idFile" class="form-control" accept="image/*,.pdf" required>
                                    <small class="text-danger d-none" id="fileError">Invalid file (JPG, PNG, PDF only / max 5MB)</small>
                                </div>
                            </div>

                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" required>
                                <label class="form-check-label">
                                    I agree to the <a href="#">Terms and Conditions</a>
                                </label>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" id="prevBtn">Back</button>
                                <button type="submit" class="btn btn-primary btn-lg">Register Patient</button>
                            </div>

                            <p class="text-center mt-3 text-muted">
                                Already registered? <a href="login.php">Login here</a>
                            </p>
                        </div>

                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// --- Map initialization ---
let map;
let marker;
const addressField = document.querySelector('textarea[name="address"]');

function initMap() {
    // Default location (Philippines center)
    const defaultLat = 12.8797;
    const defaultLng = 121.7740;
    
    map = L.map('mapContainer').setView([defaultLat, defaultLng], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add draggable marker (will be positioned by geolocation)
    marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);
    
    // Update address when marker is dragged
    marker.on('dragend', () => {
        const latlng = marker.getLatLng();
        getAddressFromCoordinates(latlng.lat, latlng.lng);
    });
    
    // Also allow clicking on map to move marker
    map.on('click', (e) => {
        marker.setLatLng(e.latlng);
        getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
    });
    
    // Auto-detect user's location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Move map and marker to user's location
                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);
                
                // Auto-fill address
                getAddressFromCoordinates(lat, lng);
            },
            (error) => {
                console.log('Geolocation error:', error.message);
                // If geolocation fails, use default location already set
                getAddressFromCoordinates(defaultLat, defaultLng);
            }
        );
    } else {
        console.log('Geolocation not supported');
        getAddressFromCoordinates(defaultLat, defaultLng);
    }
}

function getAddressFromCoordinates(lat, lng) {
    // Use OpenStreetMap Nominatim API for reverse geocoding
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
    
    fetch(url, {
        headers: { 'User-Agent': 'PatientRegistration' }
    })
    .then(res => res.json())
    .then(data => {
        if (!data || !data.address) {
            throw new Error('No address data received');
        }
        
        // Build complete address from address components
        const addr = data.address;
        const parts = [];
        
        if (addr.house_number && addr.road) {
            parts.push(`${addr.house_number} ${addr.road}`);
        } else if (addr.road) {
            parts.push(addr.road);
        }
        
        if (addr.village) parts.push(addr.village);
        if (addr.city_district) parts.push(addr.city_district);
        if (addr.city) parts.push(addr.city);
        if (addr.municipality) parts.push(addr.municipality);
        if (addr.province) parts.push(addr.province);
        if (addr.postcode) parts.push(addr.postcode);
        if (addr.country) parts.push(addr.country);
        
        const address = parts.length > 0 ? parts.join(', ') : data.display_name;
        addressField.value = address;
    })
    .catch(err => {
        console.error('Geocoding error:', err);
        // Retry once on error
        setTimeout(() => {
            fetch(url, {
                headers: { 'User-Agent': 'PatientRegistration' }
            })
            .then(res => res.json())
            .then(data => {
                const address = data.display_name || `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                addressField.value = address;
            })
            .catch(() => {
                addressField.value = `Location detected (${lat.toFixed(4)}, ${lng.toFixed(4)}) - Please verify address`;
            });
        }, 1000);
    });
}

// Initialize map when page loads
window.addEventListener('load', initMap);

// --- Multi-step navigation ---
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const stepTabs = document.querySelectorAll('#stepTabs .nav-link');

nextBtn.addEventListener('click', () => {
    step1.classList.add('d-none');
    step2.classList.remove('d-none');
    stepTabs[0].classList.remove('active');
    stepTabs[1].classList.remove('disabled');
    stepTabs[1].classList.add('active');
});

prevBtn.addEventListener('click', () => {
    step2.classList.add('d-none');
    step1.classList.remove('d-none');
    stepTabs[1].classList.remove('active');
    stepTabs[1].classList.add('disabled');
    stepTabs[0].classList.add('active');
});

// --- ID validation ---
const idNumber = document.getElementById('idNumber');
const idType = document.getElementById('idType');
const idFile = document.getElementById('idFile');
const idError = document.getElementById('idError');
const fileError = document.getElementById('fileError');

const idRules = {
    passport: /^[A-Z0-9]{6,9}$/i,
    drivers: /^[A-Z0-9\-]{8,15}$/i,
    national: /^[0-9]{12}$/,
    philhealth: /^[0-9]{12}$/,
    sss: /^[0-9]{10}$/
};

idNumber.addEventListener('input', () => {
    const type = idType.value;
    const value = idNumber.value.trim();
    if (!type || !idRules[type]?.test(value)) {
        idError.classList.remove('d-none');
        idNumber.classList.add('is-invalid');
    } else {
        idError.classList.add('d-none');
        idNumber.classList.remove('is-invalid');
    }
});

idFile.addEventListener('change', () => {
    const file = idFile.files[0];
    const maxSize = 5 * 1024 * 1024;
    if (!file || file.size > maxSize || !file.type.match(/(image|pdf)/)) {
        fileError.classList.remove('d-none');
        idFile.classList.add('is-invalid');
        idFile.value = '';
    } else {
        fileError.classList.add('d-none');
        idFile.classList.remove('is-invalid');
    }
});

// --- Form submission with fetch ---
const patientForm = document.getElementById('patientForm');

patientForm.addEventListener('submit', e => {
    e.preventDefault();

    if (idNumber.classList.contains('is-invalid') || idFile.classList.contains('is-invalid') || !idType.value) {
        alert('Please provide a valid ID before submitting.');
        return;
    }

    const formData = new FormData(patientForm);

    fetch('register-patient.php', {
        method: 'POST',
        body: formData
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(data => Promise.reject(data));
        }
        return res.json();
    })
    .then(data => {
        alert(data.message);
        if (data.status === 'success') {
            patientForm.reset();
            // Return to Step 1
            step2.classList.add('d-none');
            step1.classList.remove('d-none');
            stepTabs[1].classList.add('disabled');
            stepTabs[1].classList.remove('active');
            stepTabs[0].classList.add('active');
        }
    })
    .catch(err => {
        console.error('Registration Error:', err);
        const message = err.message || 'An unexpected error occurred. Check console for details.';
        alert(message);
    });
});

</script>

</body>
</html>
