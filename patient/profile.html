<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Patient Profile</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="shortcut icon" href="assets/images/favicon.png" />
  </head>
  <body data-require-auth>
    <div class="container-scroller"></div>
    <nav class="navbar default-layout-navbar col-lg-0 col-0 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
        <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.svg" alt="logo" /></a>
        <a class="navbar-brand brand-logo-mini" href="index.html"><img src="assets/images/logo-mini.svg" alt="logo" /></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-stretch">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
          <span class="mdi mdi-menu"></span>
        </button>
        <div class="search-field d-none d-md-block">
          <form class="d-flex align-items-center h-100" action="#">
            <div class="input-group">
              <div class="input-group-prepend bg-transparent">
                <i class="input-group-text border-0 mdi mdi-magnify"></i>
              </div>
              <input type="text" class="form-control bg-transparent border-0" placeholder="Search projects">
            </div>
          </form>
        </div>
        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item nav-profile dropdown">
            <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="nav-profile-img">
                <img src="data:image/gif;base64,R0lGODlhAQABAAAAACw=" alt="image" id="patientProfileImage" data-default-src="assets/images/faces/face1.jpg">
                <span class="availability-status online"></span>
              </div>
              <div class="nav-profile-text">
                <p class="mb-1 text-black" data-patient-name>Patient</p>
              </div>
            </a>
            <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
              <a class="dropdown-item" href="#">
                <i class="mdi mdi-cached me-2 text-success"></i> Activity Log </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="profile.html">
                <i class="mdi mdi-account me-2 text-info"></i> Profile Settings </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="../auth/api/logout.php">
                <i class="mdi mdi-logout me-2 text-primary"></i> Signout </a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="mdi mdi-email-outline"></i>
              <span class="count-symbol bg-warning d-none" id="messageCount"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
              <h6 class="p-3 mb-0">Messages</h6>
              <div class="dropdown-divider"></div>
              <div id="messageList"></div>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown">
              <i class="mdi mdi-bell-outline"></i>
              <span class="count-symbol bg-danger d-none" id="notificationCount"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
              <h6 class="p-3 mb-0">Notifications</h6>
              <div class="dropdown-divider"></div>
              <div id="notificationList"></div>
            </div>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
          <span class="mdi mdi-menu"></span>
        </button>
      </div>
    </nav>

    <div class="container-fluid page-body-wrapper">
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="user.html">
              <span class="menu-title">Dashboard</span>
              <i class="mdi mdi-home menu-icon"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="appointment.html">
              <span class="menu-title">My Appointments</span>
              <i class="mdi mdi-calendar-check menu-icon"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="schedule.html">
              <span class="menu-title">Schedule Checkup</span>
              <i class="mdi mdi-calendar-plus menu-icon"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="records.html">
              <span class="menu-title">Medical Records</span>
              <i class="mdi mdi-file-document-outline menu-icon"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="tracker.html">
              <span class="menu-title">Pregnancy Tracker</span>
              <i class="mdi mdi-baby-face-outline menu-icon"></i>
            </a>
          </li>
        </ul>
      </nav>

      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title">
              <span class="page-title-icon bg-gradient-primary text-white me-2">
                <i class="mdi mdi-account"></i>
              </span> Profile Settings
            </h3>
          </div>

          <div class="row">
            <div class="col-lg-6 grid-margin">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Profile Image</h4>
                  <div class="text-center mb-3">
                    <img id="profilePreview" src="assets/images/faces/face1.jpg" alt="Profile" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">
                  </div>
                  <form id="profileForm" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" id="profileCsrfToken">
                    <div class="mb-3">
                      <label class="form-label">Upload new profile photo</label>
                      <input type="file" class="form-control" id="profileImageInput" name="profile_image" accept="image/jpeg,image/png" required>
                      <small class="text-muted">JPG or PNG only, max 5MB.</small>
                    </div>
                    <button type="submit" class="btn btn-primary" id="profileSaveBtn">Save Photo</button>
                    <div class="alert alert-success d-none mt-3" id="profileSuccess"></div>
                    <div class="alert alert-danger d-none mt-3" id="profileError"></div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/misc.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/todolist.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <script src="assets/js/dashboard.js?v=20260209"></script>
    <script src="assets/js/patient-app.js?v=20260209"></script>
    <script>
      (function () {
        var preview = document.getElementById('profilePreview');
        var input = document.getElementById('profileImageInput');
        var form = document.getElementById('profileForm');
        var saveBtn = document.getElementById('profileSaveBtn');
        var successEl = document.getElementById('profileSuccess');
        var errorEl = document.getElementById('profileError');

        function showMessage(el, text) {
          if (!el) return;
          if (!text) {
            el.classList.add('d-none');
            el.textContent = '';
            return;
          }
          el.textContent = text;
          el.classList.remove('d-none');
        }

        PatientApp.requirePatient().then(function () {
          return PatientApp.apiFetch('/patient-profile.php');
        }).then(function (data) {
          if (data.profile_image) {
            preview.src = '../' + data.profile_image;
            var profileImg = document.getElementById('patientProfileImage');
            if (profileImg) profileImg.src = '../' + data.profile_image;
          }
        });

        fetch('../auth/api/get-csrf-token.php')
          .then(function (res) { return res.json(); })
          .then(function (data) { document.getElementById('profileCsrfToken').value = data.token; });

        input.addEventListener('change', function () {
          var file = input.files[0];
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });

        form.addEventListener('submit', function (e) {
          e.preventDefault();
          showMessage(successEl, '');
          showMessage(errorEl, '');

          var formData = new FormData(form);
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';

          fetch('../auth/api/patient-profile.php', {
            method: 'POST',
            body: formData
          }).then(function (res) {
            return res.text().then(function (text) {
              var data;
              try {
                data = JSON.parse(text);
              } catch (e) {
                throw new Error(text || 'Invalid server response');
              }
              if (!res.ok || data.status !== 'success') {
                throw new Error(data.message || 'Upload failed');
              }
              return data;
            });
          }).then(function (data) {
            showMessage(successEl, 'Profile updated.');
            if (data.profile_image) {
              var src = '../' + data.profile_image;
              var busted = src + '?v=' + Date.now();
              preview.src = busted;
              var profileImg = document.getElementById('patientProfileImage');
              if (profileImg) profileImg.src = busted;
            }
            form.reset();
          }).catch(function (err) {
            showMessage(errorEl, err.message || 'Upload failed');
          }).finally(function () {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Photo';
          });
        });
      })();
    </script>
  </body>
</html>
