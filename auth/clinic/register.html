<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clinic Registration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">Clinic Registration</h4>
                    <small>Register your Lying-In Clinic</small>
                </div>

                <div class="card-body p-4">

                    <!-- STEP INDICATOR -->
                    <ul class="nav nav-pills mb-4 justify-content-center" id="stepTabs">
                        <li class="nav-item">
                            <button class="nav-link active" type="button">Step 1</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link disabled" type="button">Step 2</button>
                        </li>
                    </ul>

                    <form id="clinicForm" enctype="multipart/form-data">

                        <!-- STEP 1 -->
                        <div id="step1">

                            <h6 class="text-primary mb-3">Clinic Information</h6>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Clinic Name</label>
                                    <input type="text" name="clinic_name" class="form-control" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">License Number</label>
                                    <input type="text" name="license_number" class="form-control" required>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Address</label>
                                    <textarea name="address" class="form-control" rows="2" required></textarea>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <div class="input-group">
                                        <input type="email" id="emailInput" name="email" class="form-control" required>
                                        <button class="btn btn-outline-primary" type="button" id="verifyEmailBtn">Verify</button>
                                    </div>
                                    <div id="emailVerificationStatus" class="mt-2"></div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Contact Number</label>
                                    <input type="text" name="contact_number" class="form-control" required>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-primary" id="nextBtn" disabled>Next</button>
                            </div>
                        </div>

                        <!-- STEP 2 -->
                        <div id="step2" class="d-none">

                            <h6 class="text-primary mb-3">Admin Account & Verification</h6>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Admin Name</label>
                                    <input type="text" name="admin_name" class="form-control" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" name="username" class="form-control" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Password</label>
                                    <input type="password" name="password" class="form-control" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" name="confirm_password" class="form-control" required>
                                </div>
                            </div>

                            <h6 class="text-primary mb-3">ID Verification</h6>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">ID Type</label>
                                    <select name="id_type" class="form-select" required>
                                        <option value="">Select ID</option>
                                        <option value="nbi">NBI Clearance</option>
                                        <option value="passport">Passport</option>
                                        <option value="drivers">Driver's License</option>
                                        <option value="national">National ID</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">ID Number</label>
                                    <input type="text" name="id_number" class="form-control" required>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Upload ID Document</label>
                                    <input type="file" name="id_file" class="form-control" accept="image/*,.pdf" required>
                                </div>
                            </div>

                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" required>
                                <label class="form-check-label">
                                    I agree to the <a href="#">Terms and Conditions</a>
                                </label>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" id="prevBtn">Back</button>
                                <button type="submit" class="btn btn-primary btn-lg">Register Clinic</button>
                            </div>

                        </div>

                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- OTP VERIFICATION MODAL -->
<div class="modal fade" id="otpVerificationModal" tabindex="-1" aria-labelledby="otpVerificationLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="otpVerificationLabel">
                    <i class="bi bi-envelope"></i> Email Verification
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted text-center">We've sent a 6-digit code to your email. Please enter it below.</p>
                
                <form id="otpForm">
                    <div class="mb-3">
                        <label class="form-label">Verification Code</label>
                        <input type="text" id="otpInput" class="form-control form-control-lg text-center" 
                               placeholder="000000" maxlength="6" inputmode="numeric" required>
                        <small class="text-muted">Valid for 10 minutes</small>
                    </div>
                    
                    <div id="otpErrorMsg"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitOtpBtn">Verify OTP</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========== OTP VERIFICATION SYSTEM ==========
let verifiedEmail = null;

const emailInput = document.getElementById('emailInput');
const verifyEmailBtn = document.getElementById('verifyEmailBtn');
const emailVerificationStatus = document.getElementById('emailVerificationStatus');

verifyEmailBtn.addEventListener('click', async function() {
    const email = emailInput.value.trim();
    
    // Validate email format
    if (!email || !email.includes('@')) {
        showEmailStatus('Please enter a valid email address', 'danger');
        return;
    }
    
    // Send OTP
    verifyEmailBtn.disabled = true;
    verifyEmailBtn.textContent = 'Sending OTP...';
    
    try {
        const candidates = ['auth/api/send-otp.php', '/THESIS/LYINGIN/auth/api/send-otp.php', '/THESIS/LYINGIN/auth/api/send-otp.php'];
        let data = null;
        for (const url of candidates) {
            try {
                console.log('Attempting clinic OTP send to:', url);
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'email=' + encodeURIComponent(email) + '&user_type=clinic'
                });
                const text = await resp.text();
                try { data = JSON.parse(text); if (!resp.ok) throw { url, status: resp.status, data }; break; } catch (e) { console.warn('Non-JSON or error response from', url); continue; }
            } catch (err) { console.warn('Attempt failed for', url, err); continue; }
        }
        if (!data) throw new Error('All OTP endpoints failed');
        
        if (data.status === 'success') {
            showEmailStatus('OTP sent! Check your email.', 'success');
            showOTPModal(email);
        } else {
            showEmailStatus(data.message || 'Failed to send OTP', 'danger');
            verifyEmailBtn.disabled = false;
            verifyEmailBtn.textContent = 'Verify';
        }
    } catch (error) {
        console.error('Error:', error);
        showEmailStatus('Error sending OTP. Server endpoint not found or returned an error. Check console.', 'danger');
        verifyEmailBtn.disabled = false;
        verifyEmailBtn.textContent = 'Verify';
    }
});

function showEmailStatus(message, type) {
    emailVerificationStatus.innerHTML = `<div class="alert alert-${type} mb-0 small">${message}</div>`;
}

function showOTPModal(email) {
    const otpModal = new bootstrap.Modal(document.getElementById('otpVerificationModal'));
    
    const otpForm = document.getElementById('otpForm');
    const otpInput = document.getElementById('otpInput');
    const submitOtpBtn = document.getElementById('submitOtpBtn');
    const otpErrorMsg = document.getElementById('otpErrorMsg');
    
    otpInput.value = '';
    otpErrorMsg.innerHTML = '';
    submitOtpBtn.disabled = false;
    submitOtpBtn.textContent = 'Verify OTP';
    
    submitOtpBtn.onclick = async function() {
        const otp = otpInput.value.trim();
        
        if (!otp || otp.length !== 6) {
            otpErrorMsg.innerHTML = '<div class="alert alert-danger mb-0 small">Please enter a 6-digit OTP</div>';
            return;
        }
        
        submitOtpBtn.disabled = true;
        submitOtpBtn.textContent = 'Verifying...';
        
        try {
            const candidates = ['auth/api/verify-otp.php', '/THESIS/LYINGIN/auth/api/verify-otp.php', '/THESIS/LYINGIN/auth/api/verify-otp.php'];
            let data = null;
            for (const url of candidates) {
                try {
                    console.log('Attempting clinic OTP verify to:', url);
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'email=' + encodeURIComponent(email) + '&otp=' + encodeURIComponent(otp)
                    });
                    const text = await resp.text();
                    try { data = JSON.parse(text); if (!resp.ok) throw { url, status: resp.status, data }; break; } catch (e) { console.warn('Non-JSON or error response from', url); continue; }
                } catch (err) { console.warn('Attempt failed for', url, err); continue; }
            }
            if (!data) throw new Error('All OTP verify endpoints failed');
            
            if (data.status === 'success') {
                verifiedEmail = email;
                // Keep input readonly instead of disabled so it remains in form submission
                emailInput.readOnly = true;
                let hiddenEmail = document.getElementById('hiddenVerifiedEmail');
                if (!hiddenEmail) {
                    hiddenEmail = document.createElement('input');
                    hiddenEmail.type = 'hidden';
                    hiddenEmail.id = 'hiddenVerifiedEmail';
                    hiddenEmail.name = 'email';
                    document.getElementById('clinicForm').appendChild(hiddenEmail);
                }
                hiddenEmail.value = email;

                verifyEmailBtn.disabled = true;
                verifyEmailBtn.classList.add('btn-success');
                verifyEmailBtn.classList.remove('btn-outline-primary');
                verifyEmailBtn.textContent = 'âœ“ Verified';
                
                showEmailStatus('Email verified successfully!', 'success');
                otpModal.hide();
                
                // Enable Next button if email is verified
                document.getElementById('nextBtn').disabled = false;
            } else {
                otpErrorMsg.innerHTML = '<div class="alert alert-danger mb-0 small">' + (data.message || 'Invalid OTP') + '</div>';
                submitOtpBtn.disabled = false;
                submitOtpBtn.textContent = 'Verify OTP';
            }
        } catch (error) {
            console.error('Error:', error);
            otpErrorMsg.innerHTML = '<div class="alert alert-danger mb-0 small">Error verifying OTP. Server endpoint not found or returned an error. Check console.</div>';
            submitOtpBtn.disabled = false;
            submitOtpBtn.textContent = 'Verify OTP';
        }
    };
    
    otpModal.show();
}

// Block form submission if email not verified
document.getElementById('clinicForm').addEventListener('submit', function(e) {
    if (!verifiedEmail) {
        e.preventDefault();
        showEmailStatus('Please verify your email first before registering', 'danger');
        return false;
    }
});
</script>

<script src="register.js"></script>

</body>
</html>
